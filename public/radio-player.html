<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mini Radio Player</title>
    <style>
      :root {
        --bg: #0f1115;
        --fg: #e6e9ef;
        --sub: #a0a4ae;
        --accent: #7aa2f7;
        --muted: #23262d;
        --hover: #1a1d24;
        --active: #2b2f3a;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto,
          'Helvetica Neue', Arial;
      }
      .wrap {
        max-width: 800px;
        margin: 0 auto;
        padding: 16px;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 4px; /* tight gap between list and controls */
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 8px;
      }
      header h1 {
        margin: 0;
        font-size: 16px;
        color: var(--fg);
      }
      header .query {
        color: var(--sub);
        font-size: 13px;
      }
      #status {
        font-size: 12px;
        color: var(--sub);
      }

      /* adaptive playlist height */
      .list {
        border: 1px solid var(--muted);
        border-radius: 10px;
        overflow: hidden;
        background: var(--muted);
        display: grid;
        grid-template-rows: auto 1fr;
        height: auto;
      }
      .list-header {
        padding: 10px 12px;
        background: var(--hover);
        color: var(--sub);
        font-size: 12px;
        letter-spacing: 0.4px;
        text-transform: uppercase;
      }
      #playlist {
        list-style: none;
        margin: 0;
        padding: 0;
        overflow: auto;
        max-height: calc(
          100vh - 220px
        ); /* fills viewport but leaves space for controls */
      }
      #playlist li {
        padding: 12px 12px 12px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        cursor: pointer;
        display: grid;
        gap: 4px;
        transition: background 0.2s, box-shadow 0.2s;
      }
      #playlist li:hover {
        background: var(--hover);
      }

      /* vivid highlight */
      #playlist li.active {
        background: linear-gradient(90deg, var(--accent) 0%, #475fce 100%);
        color: #fff;
        box-shadow: 0 0 10px rgba(122, 162, 247, 0.5);
      }
      #playlist li.active .station-name {
        color: #fff;
        font-weight: 700;
      }
      #playlist li.active .station-tags,
      #playlist li.active .station-loc {
        color: rgba(255, 255, 255, 0.9);
      }

      .station-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      .station-name {
        font-weight: 600;
        color: var(--fg);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-grow: 1;
        margin-right: 8px;
      }
      .station-loc {
        font-size: 12px;
        color: var(--sub);
        opacity: 0.55; /* dimmer */
        white-space: nowrap;
        flex-shrink: 0;
      }
      .station-tags {
        font-size: 12px;
        color: var(--sub);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .controls {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border: 1px solid var(--muted);
        border-radius: 10px;
        background: var(--muted);
      }
      .btnrow {
        display: inline-flex;
        gap: 10px;
        align-items: center;
      }
      button.icon {
        background: var(--hover);
        color: var(--fg);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 30px;
        cursor: pointer;
        min-width: 44px;
        min-height: 44px;
      }
      button.icon:active {
        transform: translateY(1px);
      }
      .nowplaying {
        color: var(--sub);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .volume {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .volume span {
        font-size: 18px;
      }
      input[type='range'] {
        width: 160px;
        accent-color: var(--accent);
      }
      #volPct {
        width: 3ch;
        text-align: right;
        color: var(--fg);
        font-variant-numeric: tabular-nums;
      }

      @media (max-width: 520px) {
        .controls {
          grid-template-columns: 1fr;
          gap: 10px;
        }
        .nowplaying {
          order: 3;
        }
        .volume {
          justify-content: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>üåí Mini Radio Player</h1>
        <div class="query" id="query"></div>
      </header>

      <div class="list">
        <div class="list-header">Stations</div>
        <ul id="playlist"></ul>
      </div>

      <div class="controls">
        <div class="btnrow">
          <button id="prevBtn" class="icon" title="Previous">‚èÆÔ∏è</button>
          <button id="playPauseBtn" class="icon" title="Play/Pause">‚èØÔ∏è</button>
          <button id="nextBtn" class="icon" title="Next">‚è≠Ô∏è</button>
        </div>
        <div class="nowplaying" id="nowPlaying">‚Äî</div>
        <div class="volume">
          <span>üîä</span>
          <input
            id="vol"
            type="range"
            min="0"
            max="1"
            step="0.01"
            value="0.9"
          />
          <span id="volPct">90%</span>
        </div>
      </div>

      <div id="status"></div>
    </div>

    <script>
      // Fixed set of mirrors (see https://api.radio-browser.info/)
      async function getRadioBrowserBase() {
        const mirrors = [
          'https://de2.api.radio-browser.info',
          'https://fi1.api.radio-browser.info',
        ];
        return mirrors[Math.floor(Math.random() * mirrors.length)];
      }

      // Search internet radio stations via Radio Browser API.
      // Query by city + (optional) state + countrycode (ISO code).
      async function search_stations({ city, state, countrycode, limit }) {
        if (!countrycode) throw new Error('Countrycode input is required');

        const base = await getRadioBrowserBase();
        // Build query (hidebroken avoids dead streams; order by popularity)
        const params = new URLSearchParams({
          city,
          countrycode: countrycode.toUpperCase(),
          limit: String(limit),
          hidebroken: 'true',
          order: 'clickcount',
          reverse: 'true',
        });
        if (state) params.set('state', state);

        const url = `${base}/json/stations/search?${params.toString()}`;
        console.log(`Radio Browser API: ${url}`);
        const resp = await fetch(url, {
          method: 'GET',
          headers: { Accept: 'application/json' },
          signal: AbortSignal.timeout(10000), // 10s timeout (browser support check)
        });
        if (!resp.ok) {
          throw new Error(`Failed at Radio Browser API: ${resp.statusText}`);
        }
        const rows = await resp.json();
        return rows
          .filter((st) => st?.url_resolved)
          .map((st) => ({
            name: st.name,
            streamUrl: st.url_resolved,
            tags: st.tags || '',
            location: {
              city: st.city || '',
              state: st.state || '',
              country: st.country || '',
              countrycode: st.countrycode || '',
              language: st.language || '',
              languagecodes: st.languagecodes || '',
            },
          }));
      }

      /* ---- Config persistence (localStorage) ---- */
      const CONFIG_KEY = 'radio_config';
      let config = { volume: 0.9, lastName: null };

      function loadConfig() {
        try {
          const raw = localStorage.getItem(CONFIG_KEY);
          if (raw) {
            const obj = JSON.parse(raw);
            if (typeof obj.volume === 'number' && isFinite(obj.volume)) {
              config.volume = Math.max(0, Math.min(1, obj.volume));
            }
            if (typeof obj.lastName === 'string' && obj.lastName.trim()) {
              config.lastName = obj.lastName.trim();
            }
          }
        } catch (_) {}
      }
      function saveConfig() {
        try {
          localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
        } catch (_) {}
      }

      /* ---- Player logic ---- */
      const qs = new URLSearchParams(location.search);
      const city = qs.get('city') || '';
      const state = qs.get('state') || '';
      const country = qs.get('country') || '';
      const countrycode = qs.get('countrycode') || country;
      const limit = parseInt(qs.get('limit') || '20', 10) || 20;

      const queryEl = document.getElementById('query');
      const statusEl = document.getElementById('status');
      const playlistEl = document.getElementById('playlist');
      const nowPlayingEl = document.getElementById('nowPlaying');
      const volEl = document.getElementById('vol');
      const volPctEl = document.getElementById('volPct');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const playPauseBtn = document.getElementById('playPauseBtn');

      queryEl.textContent =
        [
          city && `city: ${city}`,
          state && `state: ${state}`,
          countrycode && `countrycode: ${countrycode}`,
        ]
          .filter(Boolean)
          .join('  ‚Ä¢  ') || 'Add ?countrycode= (and optional &city=&state=)';

      let stations = [];
      let current = -1;
      let switchId = 0;
      const audio = new Audio();
      audio.preload = 'none';

      /* ---- Volume helpers (with persistence) ---- */
      function setVolume(v) {
        const clamped = Math.max(0, Math.min(1, v));
        audio.volume = clamped;
        volEl.value = String(clamped);
        volPctEl.textContent = `${Math.round(clamped * 100)}%`;
        config.volume = clamped;
        saveConfig();
      }
      loadConfig();
      setVolume(typeof config.volume === 'number' ? config.volume : 0.9);

      /* ---- Helpers ---- */
      function setStatus(msg) {
        statusEl.textContent = msg || '';
      }

      function scrollActiveIntoMiddle(index) {
        const container = playlistEl,
          row = container.children[index];
        if (!row) return;
        const top =
          row.offsetTop - (container.clientHeight / 2 - row.offsetHeight / 2);
        container.scrollTo({ top, behavior: 'smooth' });
      }

      function highlight(index) {
        [...playlistEl.children].forEach((li, i) =>
          li.classList.toggle('active', i === index)
        );
        scrollActiveIntoMiddle(index);
      }

      function updateNowPlaying() {
        if (current < 0 || !stations[current]) {
          nowPlayingEl.textContent = '‚Äî';
          return;
        }
        const s = stations[current];
        const prefix = audio.paused ? '' : 'Now Playing: ';
        nowPlayingEl.textContent = `${prefix}${s.name}`;
      }
      const norm = (s) => (s || '').toLowerCase().replace(/\s+/g, ' ').trim();
      function findByName(list, name) {
        const t = norm(name);
        if (!t) return -1;
        return list.findIndex((st) => norm(st.name) === t);
      }
      /* Keep URL‚Äôs station param in sync with current selection */
      function updateUrlStation(name) {
        const url = new URL(window.location.href);
        const sp = url.searchParams;
        // preserve city, countrycode, optional state; update station only
        sp.set('station', name);
        url.search = sp.toString();
        history.replaceState(null, '', url.toString());
        document.title = `${name} - Mini Radio Player`;
      }

      /* ---- Play logic ---- */
      async function playIndex(index) {
        if (index < 0 || index >= stations.length) return;
        switchId++;
        const myId = switchId;
        current = index;
        highlight(current);
        updateNowPlaying();
        updateUrlStation(stations[current].name); // sync URL to selection
        setStatus('Connecting‚Ä¶');
        try {
          audio.pause();
          audio.src = stations[current].streamUrl;
          await audio.play();
          if (myId !== switchId) return;
          setStatus('');
        } catch (e) {
          if (myId !== switchId) return;
          if (
            e &&
            (e.name === 'AbortError' ||
              /interrupted by a new load request/i.test(e.message || ''))
          )
            return;
          setStatus('Playback failed. Trying next‚Ä¶');
          setTimeout(() => {
            if (myId === switchId) next();
          }, 400);
        }
      }

      function prev() {
        if (!stations.length) return;
        playIndex(current <= 0 ? stations.length - 1 : current - 1);
      }
      function next() {
        if (!stations.length) return;
        playIndex((current + 1) % stations.length);
      }
      async function togglePlayPause() {
        if (!stations.length) return;
        if (current < 0) current = 0;
        if (!audio.src) audio.src = stations[current].streamUrl;
        if (audio.paused) {
          try {
            await audio.play();
            setStatus('');
          } catch {
            setStatus('Play failed.');
          }
        } else {
          audio.pause();
        }
        updateNowPlaying();
      }

      /* ---- DOM & audio events ---- */
      volEl.addEventListener('input', () => setVolume(parseFloat(volEl.value)));
      prevBtn.addEventListener('click', prev);
      nextBtn.addEventListener('click', next);
      playPauseBtn.addEventListener('click', togglePlayPause);

      // Prevent auto-repeat thrash for navigation keys and Space
      document.addEventListener('keydown', (e) => {
        const k = e.key;
        if (k === ' ') {
          if (e.repeat) return;
          e.preventDefault();
          togglePlayPause();
        } else if (k === 'ArrowLeft') {
          if (e.repeat) return;
          e.preventDefault();
          prev();
        } else if (k === 'ArrowRight') {
          if (e.repeat) return;
          e.preventDefault();
          next();
        } else if (k === 'ArrowUp') {
          e.preventDefault();
          setVolume(audio.volume + 0.05);
        } else if (k === 'ArrowDown') {
          e.preventDefault();
          setVolume(audio.volume - 0.05);
        }
      });

      /* Persist last played station name whenever playback starts */
      audio.addEventListener('play', () => {
        setStatus('');
        if (stations[current]) {
          config.lastName = stations[current].name;
          saveConfig();
        }
        updateNowPlaying();
      });
      audio.addEventListener('pause', () => updateNowPlaying());
      audio.addEventListener('ended', () => next());
      audio.addEventListener('error', () => {
        setStatus('Stream error. Trying next‚Ä¶');
        next();
      });

      /* ---- Init ---- */
      (async function init() {
        try {
          setStatus('Searching stations‚Ä¶');
          stations = await search_stations({ city, state, countrycode, limit });
          if (!stations.length) {
            setStatus('No stations found.');
            return;
          }

          playlistEl.innerHTML = '';
          stations.forEach((st, idx) => {
            const li = document.createElement('li');
            li.dataset.index = idx;
            const loc = [
              st.location.city,
              st.location.state,
              st.location.countrycode,
            ]
              .filter(Boolean)
              .join(', ');

            li.innerHTML = `
              <div class="station-row">
                <div class="station-name">${st.name}</div>
                ${loc ? `<div class="station-loc">${loc}</div>` : ''}
              </div>
              ${
                st.tags
                  ? `<div class="station-tags">${st.tags}${
                      st.location.language
                        ? ` ‚Äî ${st.location.language} (${st.location.languagecodes})`
                        : ''
                    }</div>`
                  : ''
              }
            `;
            li.onclick = () => playIndex(idx);
            playlistEl.appendChild(li);
          });

          /* Selection precedence: URL station > localStorage lastName > first */
          let startIndex = 0;
          const stationParam = qs.get('station') || '';
          if (stationParam) {
            const idx = findByName(stations, stationParam);
            startIndex = idx >= 0 ? idx : 0;
          } else if (config.lastName) {
            const idx = findByName(stations, config.lastName);
            startIndex = idx >= 0 ? idx : 0;
          }

          current = startIndex;
          highlight(current);
          updateNowPlaying();
          audio.src = stations[current].streamUrl; // preload without autoplay
          updateUrlStation(stations[current].name); // ensure URL reflects actual selection
          setStatus(
            `Loaded ${stations.length} stations.  Keyboard shortcuts: ‚Üê/‚Üí, Space, ‚Üë/‚Üì.`
          );
        } catch (err) {
          console.error(err);
          setStatus('Search failed. Check network or query.');
        }
      })();
    </script>
  </body>
</html>
